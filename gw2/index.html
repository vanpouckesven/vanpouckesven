<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

    <title>GuildWars2 Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/locale/be.js"></script>
    <script src="./data/DefaultDailyItems.js"></script>
    <script src="./data/WorldBossSpawnTimes.js"></script>

    <style>
      .badge {
        padding: 7px 12px;
      }

      h1 {
        margin: 50px 0;
      }

      thead tr td {
        font-weight: bold;
      }
    </style>
  </head>
  <body>

    <div class="container">

      <h1 class="display-4">GuildWars2 Dashboard</h1>

      <div id="guildwars2App">

        <div class="row" v-if="currentWorldBoss && nextWorldBoss">
          <div class="col-md-6">
            <div class="alert alert-warning">
              <h4>Upcomming World Boss ({{ currentWorldBoss.durationHours }}:{{ currentWorldBoss.durationMinutes }})</h4>

              <p>
                <h5>{{ currentWorldBoss.boss.name }} ({{ currentWorldBoss.hour }}:{{ currentWorldBoss.minutes }})</h5>
                {{ currentWorldBoss.boss.map }}
                <br>{{ currentWorldBoss.boss.location }} - {{ currentWorldBoss.boss.waypoint }} - {{ currentWorldBoss.boss.waypoint_code }}
              </p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info">
              <h4>Next World Boss ({{ nextWorldBoss.durationHours }}:{{ nextWorldBoss.durationMinutes }})</h4>
              <p>
                <h5>{{ nextWorldBoss.boss.name }} ({{ nextWorldBoss.hour }}:{{ nextWorldBoss.minutes }})</h5>
                {{ nextWorldBoss.boss.map }}
                <br>{{ nextWorldBoss.boss.location }} - {{ nextWorldBoss.boss.waypoint }} - {{ nextWorldBoss.boss.waypoint_code }}
              </p>
            </div>
          </div>
        </div>

        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <td>Description</td>
              <td>Map</td>
              <td>Location</td>
              <td>Waypoint</td>
              <td><span class="badge badge-pill badge-success">{{selectedDailyItems}} / {{dailyItems.length}}</span></td>
            </tr>
          </thead>
          <tr v-for="dailyItem in dailyItems">
            <td>{{dailyItem.name}}</td>
            <td>{{dailyItem.map}}</td>
            <td>{{dailyItem.location}}</td>
            <td>{{dailyItem.waypoint}}</td>
            <td class="text-center"><input type="checkbox" v-model="dailyItem.completed" v-on:click="selectDailyItem(dailyItem)"/></td>
          </tr>
        </table>
        </ul>
      </div>
    </div>

<script type="text/javascript">

  var app = new Vue({
    el: '#guildwars2App',
    methods: {
      selectDailyItem: function(dailyItem) {
        if(!dailyItem.completed) {
          this.selectedDailyItems++;
        }
        else {
          this.selectedDailyItems--;
        }
      },
      determineWorldBosses: function() {
        var today = new Date();
        var hour = today.getHours();
        var minutes = today.getMinutes();

        if(this.currentWorldBoss && this.isWorldBossUpcomming(this.currentWorldBoss, hour, minutes)) {
          this.calculateWorldBossCountdown(this.currentWorldBoss);
          this.calculateWorldBossCountdown(this.nextWorldBoss);

          this.$forceUpdate();
          return;
        }

        var currentWorldBoss = worldBossSpawnTimes[0];
        for(var i = 1; i < worldBossSpawnTimes.length; i++) {
          var nextWorldBoss = worldBossSpawnTimes[i];
          if(this.isWorldBossUpcomming(currentWorldBoss, hour, minutes)) {
            break;
          }
          else {
            currentWorldBoss = nextWorldBoss;
          }
        }

        if(currentWorldBoss == nextWorldBoss) {
          nextWorldBoss = worldBossSpawnTimes[0];
        }

        this.currentWorldBoss = currentWorldBoss;
        this.nextWorldBoss = nextWorldBoss;

        this.calculateWorldBossCountdown(this.currentWorldBoss);
        this.calculateWorldBossCountdown(this.nextWorldBoss);
        this.$forceUpdate();
      },
      isWorldBossUpcomming: function(worldBoss, currentHour, currentMinutes) {
        return currentHour < worldBoss.hour ||
          (currentHour == worldBoss.hour && currentMinutes < worldBoss.minutes);
      },
      calculateWorldBossCountdown: function(worldBoss) {
        var now = moment();
        var worldBossDate = moment();

        worldBossDate.minutes(worldBoss.minutes);
        worldBossDate.hours(worldBoss.hour);
        worldBossDate.seconds(59);

        var duration = moment.duration(worldBossDate.diff(now));

        worldBoss.durationHours = duration.hours();
        worldBoss.durationMinutes = duration.minutes();
      }
    },
    mounted: function() {
      var today = new Date();
      this.todayDateString = today.getDate() + '' + (today.getMonth() + 1) + '' + today.getFullYear();
      this.localStorageString = 'dailyItems-' + this.todayDateString;

      if (localStorage.getItem(this.localStorageString)) {
        this.dailyItems = JSON.parse(localStorage.getItem(this.localStorageString));

        var self = this;
        this.dailyItems.forEach(function(dailyItem) {
          if(dailyItem.completed) {
            self.selectedDailyItems++;
          }
        });
      }

      this.determineWorldBosses();
      setInterval(this.determineWorldBosses.bind(this), 60000);
    },
    data: {
      selectedDailyItems: 0,
      dailyItems: defaultDailyItems,
      todayDateString: '',
      localStorageString: '',
      currentWorldBoss: null,
      nextWorldBoss: null,
    },
    watch: {
      dailyItems: {
        handler() {
          console.log('DailyItems changed');
          localStorage.setItem(this.localStorageString, JSON.stringify(this.dailyItems));
        },
        deep: true
      }
    }
  })
</script>

  </body>
</html>
